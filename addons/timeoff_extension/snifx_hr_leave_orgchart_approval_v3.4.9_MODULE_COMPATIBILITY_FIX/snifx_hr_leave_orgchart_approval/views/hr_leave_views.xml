<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- Simple list view for Approval Levels tab in hr.leave form -->
    <!-- This view has minimal fields to avoid validation issues -->
    <record id="leave_approval_level_view_tree_simple" model="ir.ui.view">
      <field name="name">leave.approval.level.tree.simple</field>
      <field name="model">leave.approval.level</field>
      <field name="arch" type="xml">
        <list decoration-success="state=='approved'" 
              decoration-danger="state=='refused'" 
              decoration-warning="state=='pending'">
          <field name="level"/>
          <field name="approver_id"/>
          <field name="state" widget="badge"/>
          <field name="action_date"/>
        </list>
      </field>
    </record>

    <!-- Add Approval Levels tab to hr.leave form view -->
    <!-- Reference the simple tree view defined above -->
    <record id="hr_leave_view_form_approval_levels_tab" model="ir.ui.view">
        <field name="name">hr.leave.form.approval.levels.tab</field>
        <field name="model">hr.leave</field>
        <field name="inherit_id" ref="hr_holidays.hr_leave_view_form"/>
        <field name="arch" type="xml">
            
            <!-- Ensure description/name field shows as text, not password -->
            <xpath expr="//field[@name='name']" position="attributes">
                <attribute name="widget">text</attribute>
                <attribute name="password">False</attribute>
            </xpath>
            
            <!-- Add notebook with Approval Levels tab at the end of sheet -->
            <xpath expr="//sheet" position="inside">
                <notebook invisible="not use_orgchart_approval">
                    <page string="Approval Levels" name="approval_levels">
                        <field name="approval_level_ids" 
                               readonly="1" 
                               nolabel="1"
                               context="{'tree_view_ref': 'snifx_hr_leave_orgchart_approval.leave_approval_level_view_tree_simple'}"/>
                    </page>
                </notebook>
            </xpath>
            
        </field>
    </record>

    <!-- v3.3.5 CHANGE: Filter and Menu removed -->
    <!-- Filter "Orgchart: Waiting For Me" removed - use admin-aware filter instead -->
    <!-- If you need the old filter, install v3.3.4 or use snifx_modify_waiting_filter module -->
    
    <!-- v3.4.4 CHANGE: Hide Approve/Refuse buttons for records already approved by current user -->
    <record id="hr_leave_view_tree_hide_approved_buttons" model="ir.ui.view">
        <field name="name">hr.leave.tree.hide.approved.buttons</field>
        <field name="model">hr.leave</field>
        <field name="inherit_id" ref="hr_holidays.hr_leave_view_tree"/>
        <field name="arch" type="xml">
            
            <!-- Make current_user_already_approved field available (invisible) -->
            <xpath expr="//list" position="inside">
                <field name="current_user_already_approved" column_invisible="1"/>
            </xpath>
            
            <!-- Hide Approve button if user already approved -->
            <xpath expr="//button[@name='action_approve']" position="attributes">
                <attribute name="invisible">current_user_already_approved or state not in ('confirm', 'validate1')</attribute>
            </xpath>
            
            <!-- Hide Refuse button if user already approved -->
            <xpath expr="//button[@name='action_refuse']" position="attributes">
                <attribute name="invisible">current_user_already_approved or state not in ('confirm', 'validate', 'validate1')</attribute>
            </xpath>
            
        </field>
    </record>
    
  </data>
</odoo>
